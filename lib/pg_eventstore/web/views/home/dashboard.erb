<script type="text/html" id="stream-filter-tmpl">
  <%= erb :'partials/stream_filter', { layout: false }, { stream: {} } %>
</script>
<script type="text/html" id="event-type-filter-tmpl">
  <%= erb :'partials/event_filter', { layout: false }, { event_type: '' } %>
</script>

<div class="right_col" role="main">
  <div class="">
    <div class="page-title">
      <div class="title_left">
        <h3>Events lookup</h3>
      </div>
    </div>

    <div class="clearfix"></div>

    <div class="row" style="display: block;">
      <div class="col-md-12 col-sm-12 ">
        <div class="x_panel">
          <div class="x_title">
            <h2>Filters</h2>
            <div class="clearfix"></div>
          </div>
          <div class="x_content">
            <br/>
            <form id="filters-form" action="<%= url('/') %>" method="GET" data-parsley-validate class="form-horizontal form-label-left">
              <input type="hidden" name="per_page" value="<%= params[:per_page].to_i %>">
              <div class="stream-filters">
                <% streams_filter&.each do |attrs| %>
                  <%= erb :'partials/stream_filter', { layout: false }, { stream: attrs } %>
                <% end %>
              </div>
              <div class="event-filters">
                <% events_filter&.each do |event_type| %>
                  <%= erb :'partials/event_filter', { layout: false }, { event_type: event_type } %>
                <% end %>
              </div>
              <div class="ln_solid"></div>
              <div class="item form-group">
                <div class="col-md-6 col-sm-6 offset-md-5">
                  <div class="btn-group">
                    <button type="submit" class="btn btn-success">Search</button>
                  </div>
                  <div class="btn-group">
                    <div class="dropdown">
                      <button class="btn btn-secondary dropdown-toggle" type="button"
                              data-toggle="dropdown" aria-expanded="false">
                        Add filter
                      </button>
                      <div class="dropdown-menu">
                        <a class="dropdown-item add-stream-filter" href="javascript: void(0)">Add stream filter</a>
                        <a class="dropdown-item add-event-filter" href="javascript: void(0)">Add event filter</a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="clearfix"></div>
    </div>

    <div class="row">
      <div class="col-md-12 col-sm-12">
        <div class="x_panel">
          <div class="x_title">
            <div class="row">
              <div class="col-md-3 col-sm-12">
                <h2>
                  Events
                  <small><%= total_count(@collection.total_count) %></small>
                </h2>
                <div class="clearfix"></div>
              </div>
              <div class="col-md-6 col-sm-12">
                <form class="form-horizontal form-label-left float-md-right">
                  <div class="form-group float-md-right">
                    <label class="control-label text-nowrap float-left mr-2" for="per_page_select">Per page</label>
                    <select class="page-link text-dark float-left" name="per_page" id="per_page_select">
                      <% PgEventstore::Paginator::EventsCollection::PER_PAGE.keys.each do |per_page| %>
                        <option <%= 'selected="selected"' if params[:per_page] == per_page %> data-url="<%= per_page_url(per_page) %>">
                          <%= per_page %>
                        </option>
                      <% end %>
                    </select>
                    <button type="submit" class="d-none"></button>
                  </div>
                </form>
              </div>
              <div class="col-md-3 col-sm-12">
                <nav aria-label="Page navigation">
                  <ul class="pagination justify-content-md-end">
                    <%= first_page_link %>
                    <%= previous_page_link(@collection) %>
                    <%= next_page_link(@collection) %>
                  </ul>
                </nav>
                <div class="clearfix"></div>
              </div>
              <div class="clearfix"></div>
            </div>
          </div>
          <div class="x_content table-responsive">
            <table class="table table-hover">
              <thead>
              <tr>
                <th>
                  Global position
                  <% if params[:order] == 'asc' %>
                    <a href="<%= sort_url('desc') %>"><i class="fa fa-sort-desc"></i></a>
                  <% else %>
                    <a href="<%= sort_url('asc') %>"><i class="fa fa-sort-asc"></i></a>
                  <% end %>
                </th>
                <th>Stream revision</th>
                <th>Context</th>
                <th>Stream name</th>
                <th>Stream ID</th>
                <th>Event type</th>
                <th>Created at(UTC)</th>
                <th>Event ID</th>
                <th></th>
              </tr>
              </thead>
              <tbody>
              <% @collection.collection.each do |event| %>
                <tr>
                  <td><%= event.global_position %></td>
                  <td><%= event.stream_revision %></td>
                  <td><%= event.stream.context %></td>
                  <td><%= event.stream.stream_name %></td>
                  <td><%= event.stream.stream_id %></td>
                  <td><%= event.type %></td>
                  <td><%= event.created_at.strftime('%F %T') %></td>
                  <td><%= event.id %></td>
                  <td><a href="javascript: void(0);" class="d-inline-block text-nowrap toggle-event-data">JSON <i
                    class="fa fa-eye"></i> </a></td>
                </tr>
                <tr class="event-payload d-none">
                  <td colspan="8">
                    <strong>Data:</strong>
                    <pre><%= JSON.pretty_generate(event.data) %></pre>
                    <strong>Metadata:</strong>
                    <pre><%= JSON.pretty_generate(event.metadata) %></pre>
                  </td>
                </tr>
              <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="clearfix"></div>
    </div>
  </div>
</div>
